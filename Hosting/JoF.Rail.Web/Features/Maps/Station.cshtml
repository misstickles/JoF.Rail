@*
    Thunderforest: https://manage.thunderforest.com/dashboard
*@

<h2>Station Map</h2>

<div id="stationMap" class="w-100">&nbsp;</div>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
          integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
          crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
}

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
            integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
            crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        var $map = $("#stationMap");
        var $footer = $("footer");
        $map.css('height', window.innerHeight) - parseInt($footer.outerHeight());
        $map.css('width', window.innerWidth);

        $.ajax({
            context: this,
            url: "/api/StationMapMarkers/All",
            dataType: "json",
            success: function (data) { addMarkers(data); },
            error: function (data, type) {
                alert("Oh pants.  Error :o( ");
            }
        });

        var map = L.map("stationMap", {
            center: new L.LatLng(51.0, -0.1),
            zoom: 13
        });

        L.tileLayer("https://tile.thunderforest.com/{style}/{z}/{x}/{y}{r}.png", { //?apikey={apiKey}', {
            attribution: "Maps &copy; <a href='https://thunderforest.com'>Thunderforest</a> | Data &copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors",
            maxZoom: 18,
            style: 'transport',
            apiKey: 'f31707f58bde4a80baf55db6692385f6'
        }).addTo(map);

        var markers = new L.MarkerClusterGroup({});

        function addMarkers(data) {
            var stations = data.stations.map(function (location, i) {
                markers.addLayer(
                    L.marker([location.latitude, location.longitude])
                        .bindTooltip(location.name)
                        .openTooltip()
                    .bindPopup(`<p><strong>${location.name}</strong><br />${location.operator}</p>Location: (${location.latitude}, ${location.longitude})`)
                    .openPopup()
                );
            });

            map.addLayer(markers);
        }
    </script>
}

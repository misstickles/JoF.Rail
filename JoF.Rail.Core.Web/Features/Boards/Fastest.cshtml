@model JoF.Rail.Standard.Models.LiveDepartureBoard.Result.DeparturesBoardModel
@{
    ViewBag.Title = "Next Fastest Departure";
    ViewBag.BodyClass = "bg-departure-board text-departure-board";
}

@if (Model.Departures.First().Service == null)
{
<div class="container">
    <div class="d-block text-center">No services found.  Please ensure stations are a direct route.</div>
    <div class="d-block text-center"><a class="btn btn-primary" asp-action="Index"><i class="fas fa-map-marker-alt"></i> Change Station</a></div>
</div>
}
else
{
    // tiresomly, response does not contain the FilterStation...  CANNOT get flippin Linq to work...
    var callingPoints = Model.Departures.First().Service.SubsequentCallingPoints.First().CallingPoints;
    var filtered = new JoF.Rail.Standard.Models.LiveDepartureBoard.Result.CallingPointModel();

    foreach (var p in callingPoints)
    {
        if (p.Crs.Equals(Model.Departures.First().Crs))
        {
            filtered = p;
        }
    }

<div class="container">
    <div class="row align-content-center">
        <div class="col-5">
            <h2>Fastest Departure</h2>
        </div>
        <div class="col-7 text-right">
            @{
                var parms = new Dictionary<string, string>
                                {
                                    { "crs", Model.Crs },
                                    { "filterCrs", filtered.Crs },
                                };
            }
            <a class="btn btn-primary d-none d-sm-inline" asp-action="Departures" asp-all-route-data="parms">Departures</a>
            <a class="btn btn-primary d-sm-none" asp-action="Departures" asp-all-route-data="parms">Deps</a>

            <a class="btn btn-primary d-none d-sm-inline" asp-action="Arrivals" asp-all-route-data="parms">Arrivals</a>
            <a class="btn btn-primary d-sm-none" asp-action="Arrivals" asp-all-route-data="parms">Arrs</a>

            <a class="btn btn-primary d-none d-sm-inline" asp-action="Index">Change Station</a>
            <a class="btn btn-primary d-sm-none" asp-action="Index"><i class="fas fa-map-marker-alt"></i></a>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <h3>from @Model.Location to @filtered.Location</h3>
        </div>
    </div>
</div>

<div class="container bg-danger text-white">
    <div class="row">
        @foreach (var message in Model.Messages)
        {
            <div class="col-12 py-2">@Html.Raw(message)</div>
        }
    </div>
</div>

<div class="container departure-board">
    <div class="row align-items-center py-3">
        <div class="col-2 text-center d-none d-sm-block"><strong>Departs</strong></div>
        <div class="col-3 d-none d-sm-block"><strong>Destination</strong></div>
        <div class="col-2 text-center d-none d-sm-block"><strong>Expected</strong></div>
        <div class="col-1 text-center d-none d-sm-block"><strong>Delay</strong></div>
        <div class="col-1 text-center d-none d-sm-block"><strong>Plat</strong></div>
        <div class="col-1 text-center d-none d-sm-block"><strong>Coaches</strong></div>
    </div>
    <div class="row align-items-center d-sm-none">
        <div class="col-2 text-center d-sm-none"><strong>Dep</strong></div>
        <div class="col-3 d-sm-none"><strong>Dest</strong></div>
        <div class="col-2 text-center d-sm-none"><strong>Exp</strong></div>
        <div class="col-1 text-center d-sm-none"><i class="fas fa-clock"></i></div>
        <div class="col-1 text-center d-sm-none"><strong>P</strong></div>
        <div class="col-1 text-center d-sm-none"><strong>#</strong></div>
    </div>

    <div id="accordion">
        @foreach (var departure in Model.Departures)
        {
            var service = departure.Service;

            <div class="pb-3" role="button" data-toggle="collapse" data-target="#@service.Id" aria-expanded="false" aria-controls="#@service.Id">
                <div class="row pb-2">
                    <div class="col-2 text-center">@service.ScheduledTimeDeparture</div>
                    <div class="col-3">
                        @foreach (var dest in service.Destinations)
                        {
                            <div class="d-block">@dest.Location</div>
                            @if (dest.Via != null)
                            {
                                <small class="indent d-none d-sm-block">@dest.Via</small>
                            }
                        }
                    </div>
                    <div class="col-2 text-center">@service.EstimatedTimeDeparture</div>
                    <div class="col-1 text-center">@service.EstimatedTimeDepartureDelay</div>
                    <div class="col-1 text-center">@service.Platform</div>
                    <div class="col-1 text-center">@service.TrainLength</div>
                    <div class="col-1">
                        <button class="btn btn-dark" type="button" data-toggle="collapse" data-target="#@service.Id" aria-expanded="false" aria-controls="collapseExample">
                            <i class="fas fa-info"></i>
                        </button>
                    </div>
                </div>
                @if (service.DelayReason != null || service.CancellationReason != null)
                {
                    <div class="row">
                        <div class="col-12 text-danger">
                            @if (service.DelayReason != null && service.CancellationReason == null)
                            {
                                @service.DelayReason
                            }
                            @if (service.CancellationReason != null)
                            {
                                @service.CancellationReason
                            }
                        </div>
                    </div>
                }
                <div class="collapse" id="@service.Id" aria-labelledby="@service.Id" data-parent="#accordion">
                    @{
                        ViewData["Here"] = Model.Location;
                        ViewData["There"] = filtered.Location;
                    }
                    <partial name="_TrainServiceDetails" model="service" , view-data="ViewData" />
                </div>
            </div>
                        }
        </div>

        <div class="row py-3">
            <small class="col-12 text-right">@Model.GeneratedAt</small>
        </div>

        <small class="row d-sm-none pb-3">
            <div class="col">
                <i class="fas fa-clock"></i> - Delay, minutes
                <div>P - Platform number</div>
                <div># - Number of coaches</div>
            </div>
        </small>
    </div>
}
